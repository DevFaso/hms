name: Deploy to Railway

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - uat
          - prod

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'prod') || 'dev' }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Resolve Railway token
        id: token
        run: |
          ENV="${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'prod') || 'dev' }}"
          case "$ENV" in
            prod) echo "railway_token=${{ secrets.HMS_PROD_TOKEN }}" >> "$GITHUB_OUTPUT" ;;
            uat)  echo "railway_token=${{ secrets.HMS_UAT_TOKEN }}"  >> "$GITHUB_OUTPUT" ;;
            *)    echo "railway_token=${{ secrets.HMS_DEV_TOKEN }}"  >> "$GITHUB_OUTPUT" ;;
          esac
          echo "env=$ENV" >> "$GITHUB_OUTPUT"

      - name: Deploy to Railway (${{ steps.token.outputs.env }})
        run: railway up --service ${{ vars.RAILWAY_SERVICE_NAME || 'hospital-core' }}
        env:
          RAILWAY_TOKEN: ${{ steps.token.outputs.railway_token }}
