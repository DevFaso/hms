name: Deploy to Railway

on:
  # Railway dev auto-deploys from develop via built-in integration.
  # Use workflow_dispatch for manual deployments to any environment.
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - uat
          - prod

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Resolve Railway token and service
        id: token
        run: |
          ENV="${{ github.event.inputs.environment }}"
          case "$ENV" in
            prod)
              echo "railway_token=${{ secrets.HMS_PROD_TOKEN }}" >> "$GITHUB_OUTPUT"
              echo "service=hospital-core" >> "$GITHUB_OUTPUT"
              ;;
            uat)
              echo "railway_token=${{ secrets.HMS_UAT_TOKEN }}" >> "$GITHUB_OUTPUT"
              echo "service=hms-backend-uat" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "railway_token=${{ secrets.HMS_DEV_TOKEN }}" >> "$GITHUB_OUTPUT"
              echo "service=hms-backend-dev" >> "$GITHUB_OUTPUT"
              ;;
          esac
          echo "env=$ENV" >> "$GITHUB_OUTPUT"

      - name: Deploy to Railway (${{ steps.token.outputs.env }})
        run: railway up --service ${{ steps.token.outputs.service }}
        env:
          RAILWAY_TOKEN: ${{ steps.token.outputs.railway_token }}
