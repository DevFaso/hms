name: Deploy to Railway

on:
  # Railway dev auto-deploys from develop via built-in integration.
  # Use workflow_dispatch for manual deployments to any environment.
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - uat
          - prod
      service:
        description: 'Service to deploy'
        required: true
        default: 'both'
        type: choice
        options:
          - both
          - backend
          - frontend

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Resolve Railway tokens and service names
        id: config
        run: |
          ENV="${{ github.event.inputs.environment }}"
          SVC="${{ github.event.inputs.service }}"
          case "$ENV" in
            prod)
              echo "backend_token=${{ secrets.HMS_PROD_TOKEN }}"    >> "$GITHUB_OUTPUT"
              echo "frontend_token=${{ secrets.HMS_PROD_TOKEN }}"   >> "$GITHUB_OUTPUT"
              echo "backend_service=hms-backend-prod"               >> "$GITHUB_OUTPUT"
              echo "frontend_service=hms-frontend-prod"             >> "$GITHUB_OUTPUT"
              ;;
            uat)
              echo "backend_token=${{ secrets.HMS_UAT_TOKEN }}"     >> "$GITHUB_OUTPUT"
              echo "frontend_token=${{ secrets.HMS_UAT_TOKEN }}"    >> "$GITHUB_OUTPUT"
              echo "backend_service=hms-backend-uat"                >> "$GITHUB_OUTPUT"
              echo "frontend_service=hms-frontend-uat"              >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "backend_token=${{ secrets.HMS_DEV_TOKEN }}"     >> "$GITHUB_OUTPUT"
              echo "frontend_token=${{ secrets.HMS_DEV_TOKEN }}"    >> "$GITHUB_OUTPUT"
              echo "backend_service=hms-backend-dev"                >> "$GITHUB_OUTPUT"
              echo "frontend_service=hms-frontend-dev"              >> "$GITHUB_OUTPUT"
              ;;
          esac
          echo "env=$ENV"   >> "$GITHUB_OUTPUT"
          echo "deploy=$SVC" >> "$GITHUB_OUTPUT"

      - name: Deploy backend to Railway (${{ steps.config.outputs.env }})
        if: steps.config.outputs.deploy == 'both' || steps.config.outputs.deploy == 'backend'
        run: |
          echo "=== Available services in project ==="
          railway service list || true
          echo "=== Deploying backend: ${{ steps.config.outputs.backend_service }} ==="
          railway up --service ${{ steps.config.outputs.backend_service }} --detach
        env:
          RAILWAY_TOKEN: ${{ steps.config.outputs.backend_token }}

      - name: Deploy frontend to Railway (${{ steps.config.outputs.env }})
        if: steps.config.outputs.deploy == 'both' || steps.config.outputs.deploy == 'frontend'
        working-directory: hospital-portal
        run: |
          echo "=== Available services in project ==="
          railway service list || true
          echo "=== Deploying frontend: ${{ steps.config.outputs.frontend_service }} ==="
          railway up --service ${{ steps.config.outputs.frontend_service }} --detach
        env:
          RAILWAY_TOKEN: ${{ steps.config.outputs.frontend_token }}
