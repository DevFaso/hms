<div class="page-container">
  <div class="page-header">
    <div>
      <h1 class="page-title">Treatment Plans</h1>
      <p class="page-subtitle">Care plans, goals, and follow-up tracking</p>
    </div>
    <div class="page-actions">
      <button class="btn-primary" (click)="openCreate()">
        <span class="material-symbols-outlined">add</span> New Plan
      </button>
    </div>
  </div>
  <div class="summary-cards">
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon active">healing</span>
      <div class="card-info">
        <span class="card-value">{{ countByGroup('active') }}</span
        ><span class="card-label">Active</span>
      </div>
    </div>
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon draft">edit_note</span>
      <div class="card-info">
        <span class="card-value">{{ countByGroup('draft') }}</span
        ><span class="card-label">Draft</span>
      </div>
    </div>
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon completed">check_circle</span>
      <div class="card-info">
        <span class="card-value">{{ countByGroup('completed') }}</span
        ><span class="card-label">Completed</span>
      </div>
    </div>
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon total">bar_chart</span>
      <div class="card-info">
        <span class="card-value">{{ plans().length }}</span
        ><span class="card-label">Total</span>
      </div>
    </div>
  </div>
  <div class="filter-bar">
    <div class="tabs">
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'all'"
        (click)="setTab('all')"
        title="Show all"
      >
        All
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'active'"
        (click)="setTab('active')"
        title="Show active"
      >
        Active
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'draft'"
        (click)="setTab('draft')"
        title="Show drafts"
      >
        Draft
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'completed'"
        (click)="setTab('completed')"
        title="Show completed"
      >
        Completed
      </button>
    </div>
    <div class="search-box">
      <span class="material-symbols-outlined">search</span
      ><input
        type="text"
        placeholder="Search treatment plans..."
        [(ngModel)]="searchTerm"
        (input)="applyFilter()"
      />
    </div>
  </div>
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading treatment plans...</p>
    </div>
  }
  @if (!loading() && filtered().length === 0) {
    <div class="empty-state">
      <span class="material-symbols-outlined empty-icon">healing</span>
      <h3>No treatment plans found</h3>
      <p>Plans will appear here.</p>
    </div>
  }
  @if (!loading() && filtered().length > 0) {
    <div class="data-table">
      <table>
        <thead>
          <tr>
            <th scope="col">Patient</th>
            <th scope="col">Problem</th>
            <th scope="col">Author</th>
            <th scope="col">Timeline</th>
            <th scope="col">Status</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (p of filtered(); track p.id) {
            <tr class="data-row">
              <td>
                <div class="cell-primary">{{ p.patientName || 'Unknown' }}</div>
              </td>
              <td class="problem-cell">{{ p.problemStatement || '—' }}</td>
              <td>{{ p.authorStaffName || '—' }}</td>
              <td>{{ p.timelineStartDate ? (p.timelineStartDate | date: 'mediumDate') : '—' }}</td>
              <td>
                <span class="status-badge {{ getStatusClass(p.status) }}">{{ p.status }}</span>
              </td>
              <td>
                <div class="action-group">
                  <button class="action-link" (click)="viewDetail(p)" title="View treatment plan">
                    <span class="material-symbols-outlined">visibility</span>
                  </button>
                  <button class="action-link" (click)="openEdit(p)" title="Edit plan">
                    <span class="material-symbols-outlined">edit</span>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
  @if (selectedPlan(); as plan) {
    <div class="detail-overlay" tabindex="-1" (keydown.escape)="closeDetail()">
      <div class="detail-panel">
        <div class="detail-header">
          <h2>Treatment Plan</h2>
          <button class="btn-close" (click)="closeDetail()" title="Close">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <div class="detail-body">
          <div class="detail-grid">
            <div class="detail-field">
              <span class="field-label">Patient</span
              ><span class="field-value">{{ plan.patientName }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Status</span
              ><span class="field-value"
                ><span class="status-badge {{ getStatusClass(plan.status) }}">{{
                  plan.status
                }}</span></span
              >
            </div>
            <div class="detail-field">
              <span class="field-label">Author</span
              ><span class="field-value">{{ plan.authorStaffName || '—' }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Supervisor</span
              ><span class="field-value">{{ plan.supervisingStaffName || '—' }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Start</span
              ><span class="field-value">{{ plan.timelineStartDate || '—' }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Review</span
              ><span class="field-value">{{ plan.timelineReviewDate || '—' }}</span>
            </div>
          </div>
          @if (plan.problemStatement) {
            <div class="detail-section">
              <span class="field-label">Problem Statement</span>
              <p>{{ plan.problemStatement }}</p>
            </div>
          }
          @if (plan.therapeuticGoals && plan.therapeuticGoals.length > 0) {
            <div class="detail-section">
              <span class="field-label">Goals</span>
              <ul>
                @for (g of plan.therapeuticGoals; track g) {
                  <li>{{ g }}</li>
                }
              </ul>
            </div>
          }
          @if (plan.medicationPlan && plan.medicationPlan.length > 0) {
            <div class="detail-section">
              <span class="field-label">Medication Plan</span>
              <ul>
                @for (m of plan.medicationPlan; track m) {
                  <li>{{ m }}</li>
                }
              </ul>
            </div>
          }
          @if (plan.followUps && plan.followUps.length > 0) {
            <div class="detail-section">
              <span class="field-label">Follow-ups</span>
              @for (f of plan.followUps; track f.id) {
                <div class="followup-item">
                  <strong>{{ f.label }}</strong
                  ><span>{{ f.dueOn ? (f.dueOn | date: 'mediumDate') : '—' }}</span
                  ><span
                    class="status-badge {{
                      f.status === 'COMPLETED' ? 'status-completed' : 'status-pending'
                    }}"
                    >{{ f.status }}</span
                  >
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- Create/Edit Treatment Plan Modal -->
  @if (showModal()) {
    <div
      class="modal-backdrop"
      tabindex="-1"
      (click)="closeModal()"
      (keydown.escape)="closeModal()"
    ></div>
    <div class="modal modal-lg">
      <div class="modal-header">
        <h2>{{ editing() ? 'Edit' : 'New' }} Treatment Plan</h2>
        <button class="modal-close" (click)="closeModal()" title="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="field">
            <label for="tp-patientId">Patient ID</label>
            <input
              id="tp-patientId"
              type="text"
              [(ngModel)]="form.patientId"
              placeholder="Patient ID"
            />
          </div>
          <div class="field">
            <label for="tp-hospitalId">Hospital</label>
            <select id="tp-hospitalId" [(ngModel)]="form.hospitalId" title="Hospital">
              <option value="">Select hospital</option>
              @for (h of hospitals(); track h.id) {
                <option [value]="h.id">{{ h.name }}</option>
              }
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label for="tp-authorStaff">Author Staff</label>
            <select id="tp-authorStaff" [(ngModel)]="form.authorStaffId" title="Author staff">
              <option value="">Select staff</option>
              @for (s of staffList(); track s.id) {
                <option [value]="s.id">{{ s.name }}</option>
              }
            </select>
          </div>
          <div class="field">
            <label for="tp-assignmentId">Assignment ID</label>
            <input
              id="tp-assignmentId"
              type="text"
              [(ngModel)]="form.assignmentId"
              placeholder="Assignment ID"
            />
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label for="tp-startDate">Start Date</label>
            <input id="tp-startDate" type="date" [(ngModel)]="form.timelineStartDate" />
          </div>
          <div class="field">
            <label for="tp-reviewDate">Review Date</label>
            <input id="tp-reviewDate" type="date" [(ngModel)]="form.timelineReviewDate" />
          </div>
        </div>
        <div class="form-row">
          <div class="field full-width">
            <label for="tp-problem">Problem Statement</label>
            <textarea
              id="tp-problem"
              [(ngModel)]="form.problemStatement"
              rows="3"
              placeholder="Describe the problem"
            ></textarea>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeModal()">Cancel</button>
        <button class="btn-primary" (click)="submitForm()" [disabled]="saving()">
          {{ saving() ? 'Saving...' : editing() ? 'Update Plan' : 'Create Plan' }}
        </button>
      </div>
    </div>
  }
</div>
