<div class="page-container">
  <div class="page-header">
    <div>
      <h1 class="page-title">Admissions</h1>
      <p class="page-subtitle">Inpatient admissions and bed management</p>
    </div>
    <div class="page-actions">
      <button class="btn-primary" (click)="openCreate()"><span class="material-symbols-outlined">add</span> New Admission</button>
    </div>
  </div>
  <div class="summary-cards">
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon admitted">hotel</span>
      <div class="card-info">
        <span class="card-value">{{ countByStatus('ADMITTED') }}</span
        ><span class="card-label">Admitted</span>
      </div>
    </div>
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon discharged">logout</span>
      <div class="card-info">
        <span class="card-value">{{ countByStatus('DISCHARGED') }}</span
        ><span class="card-label">Discharged</span>
      </div>
    </div>
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon pending">schedule</span>
      <div class="card-info">
        <span class="card-value">{{ countByStatus('PENDING') }}</span
        ><span class="card-label">Pending</span>
      </div>
    </div>
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon total">bar_chart</span>
      <div class="card-info">
        <span class="card-value">{{ admissions().length }}</span
        ><span class="card-label">Total</span>
      </div>
    </div>
  </div>
  <div class="filter-bar">
    <div class="tabs">
      <button class="tab-btn" [class.active]="activeTab() === 'all'" (click)="setTab('all')">
        All
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'admitted'"
        (click)="setTab('admitted')"
      >
        Admitted
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'discharged'"
        (click)="setTab('discharged')"
      >
        Discharged
      </button>
    </div>
    <div class="search-box">
      <span class="material-symbols-outlined">search</span
      ><input
        type="text"
        placeholder="Search admissions..."
        [(ngModel)]="searchTerm"
        (input)="applyFilter()"
      />
    </div>
  </div>
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading admissions...</p>
    </div>
  }
  @if (!loading() && filtered().length === 0) {
    <div class="empty-state">
      <span class="material-symbols-outlined empty-icon">hotel</span>
      <h3>No admissions found</h3>
      <p>Admissions will appear here.</p>
    </div>
  }
  @if (!loading() && filtered().length > 0) {
    <div class="data-table">
      <table>
        <thead>
          <tr>
            <th scope="col">Patient</th>
            <th scope="col">Room/Bed</th>
            <th scope="col">Type</th>
            <th scope="col">Acuity</th>
            <th scope="col">Chief Complaint</th>
            <th scope="col">Admitted</th>
            <th scope="col">Status</th>
            <th scope="col" class="actions-col">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (a of filtered(); track a.id) {
            <tr class="data-row">
              <td>
                <div class="cell-primary">{{ a.patientName || 'Unknown' }}</div>
              </td>
              <td>{{ a.roomBed || '—' }}</td>
              <td>{{ a.admissionType || '—' }}</td>
              <td>
                <span class="acuity-badge {{ getAcuityClass(a.acuityLevel) }}">{{
                  a.acuityLevel
                }}</span>
              </td>
              <td class="complaint-cell">{{ a.chiefComplaint || '—' }}</td>
              <td>{{ a.admissionDateTime ? (a.admissionDateTime | date: 'mediumDate') : '—' }}</td>
              <td>
                <span class="status-badge {{ getStatusClass(a.status) }}">{{ a.status }}</span>
              </td>
              <td>
                <div class="action-group">
                  <button class="action-link edit-link" (click)="openEdit(a)"><span class="material-symbols-outlined">edit</span></button>
                  <button class="action-link delete-link" (click)="confirmDelete(a)"><span class="material-symbols-outlined">delete</span></button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>

<!-- ═══ CREATE / EDIT ADMISSION MODAL ═══ -->
@if (showModal()) {
  <div class="modal-backdrop" (click)="closeModal()">
    <div class="modal modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editing() ? 'Edit Admission' : 'New Admission' }}</h2>
        <button class="modal-close" (click)="closeModal()"><span class="material-symbols-outlined">close</span></button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="field">
            <label>Patient ID *</label>
            <input type="text" [(ngModel)]="form.patientId" placeholder="Patient ID" required />
          </div>
          <div class="field">
            <label>Hospital *</label>
            <select [(ngModel)]="form.hospitalId" required>
              <option value="">Select hospital...</option>
              @for (h of hospitals(); track h.id) {
                <option [value]="h.id">{{ h.name }}</option>
              }
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label>Admitting Provider *</label>
            <select [(ngModel)]="form.admittingProviderId" required>
              <option value="">Select provider...</option>
              @for (s of staffMembers(); track s.id) {
                <option [value]="s.id">{{ s.name }}</option>
              }
            </select>
          </div>
          <div class="field">
            <label>Room / Bed</label>
            <input type="text" [(ngModel)]="form.roomBed" placeholder="e.g. Room 201-B" />
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label>Admission Type *</label>
            <select [(ngModel)]="form.admissionType" required>
              @for (t of admissionTypes; track t) {
                <option [value]="t">{{ t }}</option>
              }
            </select>
          </div>
          <div class="field">
            <label>Acuity Level *</label>
            <select [(ngModel)]="form.acuityLevel" required>
              @for (l of acuityLevels; track l) {
                <option [value]="l">{{ l }}</option>
              }
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label>Admission Date/Time *</label>
            <input type="datetime-local" [(ngModel)]="form.admissionDateTime" required />
          </div>
          <div class="field">
            <label>Department ID</label>
            <input type="text" [(ngModel)]="form.departmentId" placeholder="Optional" />
          </div>
        </div>
        <div class="field">
          <label>Chief Complaint *</label>
          <textarea [(ngModel)]="form.chiefComplaint" rows="2" placeholder="Reason for admission..." required></textarea>
        </div>
        <div class="field">
          <label>Admission Notes</label>
          <textarea [(ngModel)]="form.admissionNotes" rows="2" placeholder="Additional notes..."></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeModal()">Cancel</button>
        <button class="btn-primary" (click)="submitForm()" [disabled]="saving() || !form.patientId || !form.hospitalId || !form.admittingProviderId || !form.admissionDateTime || !form.chiefComplaint">
          {{ saving() ? 'Saving...' : (editing() ? 'Update' : 'Create') }}
        </button>
      </div>
    </div>
  </div>
}

<!-- ═══ DELETE CONFIRM ═══ -->
@if (showDeleteConfirm()) {
  <div class="modal-backdrop" (click)="cancelDelete()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header"><h2>Delete Admission</h2><button class="modal-close" (click)="cancelDelete()"><span class="material-symbols-outlined">close</span></button></div>
      <div class="modal-body">
        <p class="delete-warning">Are you sure you want to delete the admission for <strong>{{ deletingAdm()?.patientName }}</strong>? This action cannot be undone.</p>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" (click)="cancelDelete()">Cancel</button>
        <button class="btn-danger" (click)="executeDelete()" [disabled]="deleting()">{{ deleting() ? 'Deleting...' : 'Delete' }}</button>
      </div>
    </div>
  </div>
}
