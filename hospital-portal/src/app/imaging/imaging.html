<div class="page-container">
  <div class="page-header">
    <div>
      <h1 class="page-title">Imaging</h1>
      <p class="page-subtitle">Radiology orders, scheduling, and reports</p>
    </div>
    <div class="page-actions">
      <button class="btn-primary" (click)="openCreate()">
        <span class="material-symbols-outlined">add</span> New Order
      </button>
    </div>
  </div>
  <div class="summary-cards">
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon active">radiology</span>
      <div class="card-info">
        <span class="card-value">{{ countByGroup('active') }}</span
        ><span class="card-label">Active Orders</span>
      </div>
    </div>
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon completed">check_circle</span>
      <div class="card-info">
        <span class="card-value">{{ countByGroup('completed') }}</span
        ><span class="card-label">Completed</span>
      </div>
    </div>
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon total">bar_chart</span>
      <div class="card-info">
        <span class="card-value">{{ orders().length }}</span
        ><span class="card-label">Total Orders</span>
      </div>
    </div>
  </div>
  <div class="filter-bar">
    <div class="tabs">
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'all'"
        (click)="setTab('all')"
        title="Show all orders"
      >
        All
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'ordered'"
        (click)="setTab('ordered')"
        title="Show active orders"
      >
        Active
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'completed'"
        (click)="setTab('completed')"
        title="Show completed"
      >
        Completed
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'cancelled'"
        (click)="setTab('cancelled')"
        title="Show cancelled"
      >
        Cancelled
      </button>
    </div>
    <div class="search-box">
      <span class="material-symbols-outlined">search</span
      ><input
        type="text"
        placeholder="Search imaging orders..."
        [(ngModel)]="searchTerm"
        (input)="applyFilter()"
      />
    </div>
  </div>
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading imaging orders...</p>
    </div>
  }
  @if (!loading() && filtered().length === 0) {
    <div class="empty-state">
      <span class="material-symbols-outlined empty-icon">radiology</span>
      <h3>No imaging orders found</h3>
      <p>Orders will appear here.</p>
    </div>
  }
  @if (!loading() && filtered().length > 0) {
    <div class="data-table">
      <table>
        <thead>
          <tr>
            <th scope="col">Patient</th>
            <th scope="col">Modality</th>
            <th scope="col">Study</th>
            <th scope="col">Body Region</th>
            <th scope="col">Priority</th>
            <th scope="col">Ordered</th>
            <th scope="col">Status</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (o of filtered(); track o.id) {
            <tr class="data-row">
              <td>
                <div class="cell-primary">{{ o.patientDisplayName || 'Unknown' }}</div>
                <div class="cell-secondary">{{ o.patientMrn }}</div>
              </td>
              <td>
                <span class="modality-badge">{{ o.modality }}</span>
              </td>
              <td>{{ o.studyType || '—' }}</td>
              <td>{{ o.bodyRegion || '—' }}</td>
              <td>
                <span class="priority-badge {{ getPriorityClass(o.priority) }}">{{
                  o.priority
                }}</span>
              </td>
              <td>{{ o.orderedAt ? (o.orderedAt | date: 'mediumDate') : '—' }}</td>
              <td>
                <span class="status-badge {{ getStatusClass(o.status) }}">{{ o.status }}</span>
              </td>
              <td>
                <div class="action-group">
                  <button
                    class="action-link"
                    (click)="viewDetail(o)"
                    title="View imaging order details"
                  >
                    <span class="material-symbols-outlined">visibility</span>
                  </button>
                  @if (!['COMPLETED', 'FINAL', 'CANCELLED'].includes(o.status)) {
                    <button class="action-link" (click)="openEdit(o)" title="Edit order">
                      <span class="material-symbols-outlined">edit</span>
                    </button>
                    <button
                      class="action-link delete"
                      (click)="confirmCancel(o)"
                      title="Cancel order"
                    >
                      <span class="material-symbols-outlined">cancel</span>
                    </button>
                  }
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
  @if (selectedOrder(); as ord) {
    <div class="detail-overlay" tabindex="-1" (keydown.escape)="closeDetail()">
      <div class="detail-panel">
        <div class="detail-header">
          <h2>Imaging Order Details</h2>
          <button class="btn-close" (click)="closeDetail()" title="Close detail panel">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <div class="detail-body">
          <div class="detail-grid">
            <div class="detail-field">
              <span class="field-label">Patient</span
              ><span class="field-value">{{ ord.patientDisplayName }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">MRN</span
              ><span class="field-value">{{ ord.patientMrn }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Modality</span
              ><span class="field-value">{{ ord.modality }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Study Type</span
              ><span class="field-value">{{ ord.studyType }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Body Region</span
              ><span class="field-value">{{ ord.bodyRegion || '—' }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Laterality</span
              ><span class="field-value">{{ ord.laterality || '—' }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Priority</span
              ><span class="field-value"
                ><span class="priority-badge {{ getPriorityClass(ord.priority) }}">{{
                  ord.priority
                }}</span></span
              >
            </div>
            <div class="detail-field">
              <span class="field-label">Status</span
              ><span class="field-value"
                ><span class="status-badge {{ getStatusClass(ord.status) }}">{{
                  ord.status
                }}</span></span
              >
            </div>
            <div class="detail-field">
              <span class="field-label">Ordering Provider</span
              ><span class="field-value">{{ ord.orderingProviderName || '—' }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Ordered At</span
              ><span class="field-value">{{
                ord.orderedAt ? (ord.orderedAt | date: 'medium') : '—'
              }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Scheduled</span
              ><span class="field-value"
                >{{ ord.scheduledDate || '—' }} {{ ord.scheduledTime || '' }}</span
              >
            </div>
            <div class="detail-field">
              <span class="field-label">Completed</span
              ><span class="field-value">{{
                ord.completedAt ? (ord.completedAt | date: 'medium') : '—'
              }}</span>
            </div>
          </div>
          @if (ord.clinicalQuestion) {
            <div class="detail-notes">
              <span class="field-label">Clinical Question</span>
              <p>{{ ord.clinicalQuestion }}</p>
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- Create/Edit Imaging Order Modal -->
  @if (showModal()) {
    <div
      class="modal-backdrop"
      tabindex="-1"
      (click)="closeModal()"
      (keydown.escape)="closeModal()"
    ></div>
    <div class="modal modal-lg">
      <div class="modal-header">
        <h2>{{ editing() ? 'Edit' : 'New' }} Imaging Order</h2>
        <button class="modal-close" (click)="closeModal()" title="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="field">
            <label for="img-patientId">Patient ID</label>
            <input
              id="img-patientId"
              type="text"
              [(ngModel)]="form.patientId"
              placeholder="Patient ID"
            />
          </div>
          <div class="field">
            <label for="img-hospitalId">Hospital</label>
            <select id="img-hospitalId" [(ngModel)]="form.hospitalId" title="Hospital">
              <option value="">Select hospital</option>
              @for (h of hospitals(); track h.id) {
                <option [value]="h.id">{{ h.name }}</option>
              }
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label for="img-modality">Modality</label>
            <select id="img-modality" [(ngModel)]="form.modality" title="Modality">
              @for (m of modalities; track m) {
                <option [value]="m">{{ m }}</option>
              }
            </select>
          </div>
          <div class="field">
            <label for="img-priority">Priority</label>
            <select id="img-priority" [(ngModel)]="form.priority" title="Priority">
              @for (p of priorities; track p) {
                <option [value]="p">{{ p }}</option>
              }
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label for="img-studyType">Study Type</label>
            <input
              id="img-studyType"
              type="text"
              [(ngModel)]="form.studyType"
              placeholder="e.g. Chest X-Ray"
            />
          </div>
          <div class="field">
            <label for="img-bodyRegion">Body Region</label>
            <input
              id="img-bodyRegion"
              type="text"
              [(ngModel)]="form.bodyRegion"
              placeholder="e.g. Chest"
            />
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label for="img-laterality">Laterality</label>
            <input
              id="img-laterality"
              type="text"
              [(ngModel)]="form.laterality"
              placeholder="e.g. LEFT, RIGHT, BILATERAL"
            />
          </div>
          <div class="field full-width">
            <label for="img-clinicalQ">Clinical Question</label>
            <input
              id="img-clinicalQ"
              type="text"
              [(ngModel)]="form.clinicalQuestion"
              placeholder="Optional"
            />
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeModal()">Cancel</button>
        <button class="btn-primary" (click)="submitForm()" [disabled]="saving()">
          {{ saving() ? 'Saving...' : editing() ? 'Update Order' : 'Create Order' }}
        </button>
      </div>
    </div>
  }

  <!-- Cancel Imaging Order Confirmation -->
  @if (showDeleteConfirm()) {
    <div
      class="modal-backdrop"
      tabindex="-1"
      (click)="cancelDeleteAction()"
      (keydown.escape)="cancelDeleteAction()"
    ></div>
    <div class="modal">
      <div class="modal-header">
        <h2>Cancel Order</h2>
        <button class="modal-close" (click)="cancelDeleteAction()" title="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="delete-warning">
          <span class="material-symbols-outlined">warning</span>
          <p>
            Cancel the <strong>{{ deletingItem()?.modality }}</strong> order for
            <strong>{{ deletingItem()?.patientDisplayName }}</strong
            >?
          </p>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" (click)="cancelDeleteAction()">Keep</button>
        <button class="btn-danger" (click)="executeCancel()" [disabled]="deleting()">
          {{ deleting() ? 'Cancelling...' : 'Cancel Order' }}
        </button>
      </div>
    </div>
  }
</div>
