<div class="page-container">
  <div class="page-header">
    <div>
      <h1 class="page-title">Users</h1>
      <p class="page-subtitle">Manage system users and access</p>
    </div>
    <button class="btn-primary" (click)="openCreate()">
      <span class="material-symbols-outlined">person_add</span>
      Register User
    </button>
  </div>

  <div class="search-bar">
    <span class="material-symbols-outlined search-icon">search</span>
    <input
      type="text"
      placeholder="Search by name, email, role..."
      [(ngModel)]="searchTerm"
      (ngModelChange)="applyFilter()"
    />
  </div>

  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading users...</p>
    </div>
  }

  @if (!loading() && filtered().length > 0) {
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Username</th>
            <th>Role</th>
            <th>Profile</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (user of filtered(); track user.id) {
            <tr>
              <td class="name-cell">
                <div class="user-name-wrap">
                  <div class="user-avatar" [class.inactive]="!user.active">
                    {{ getInitials(user) }}
                  </div>
                  <div>
                    <span class="user-name">{{ user.firstName }} {{ user.lastName }}</span>
                    <span class="user-email">{{ user.email }}</span>
                  </div>
                </div>
              </td>
              <td>{{ user.username }}</td>
              <td>
                <span class="role-chip">{{ user.roleName || '—' }}</span>
              </td>
              <td>{{ user.profileType || '—' }}</td>
              <td>
                <span
                  class="status-badge"
                  [class.active]="user.active"
                  [class.inactive]="!user.active"
                >
                  {{ user.active ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td>
                <div class="action-group">
                  <button class="action-link edit" title="Edit" (click)="openEdit(user)">
                    <span class="material-symbols-outlined">edit</span>
                  </button>
                  <button class="action-link delete" title="Delete" (click)="confirmDelete(user)">
                    <span class="material-symbols-outlined">delete</span>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    @if (totalPages() > 1) {
      <div class="pagination">
        <button
          class="page-btn"
          [disabled]="currentPage() === 0"
          (click)="goToPage(currentPage() - 1)"
        >
          <span class="material-symbols-outlined">chevron_left</span>
        </button>
        <span class="page-info">Page {{ currentPage() + 1 }} of {{ totalPages() }}</span>
        <button
          class="page-btn"
          [disabled]="currentPage() >= totalPages() - 1"
          (click)="goToPage(currentPage() + 1)"
        >
          <span class="material-symbols-outlined">chevron_right</span>
        </button>
      </div>
    }
  }

  @if (!loading() && filtered().length === 0) {
    <div class="empty-state">
      <span class="material-symbols-outlined empty-icon">manage_accounts</span>
      <h3>No users found</h3>
      <p>{{ searchTerm ? 'Try adjusting your search.' : 'Register a new user to get started.' }}</p>
    </div>
  }

  <!-- Create User Modal -->
  @if (showCreate()) {
    <div
      class="modal-backdrop"
      (click)="closeCreate()"
      (keydown.escape)="closeCreate()"
      tabindex="-1"
    >
      <dialog
        class="modal"
        [open]="showCreate()"
        (click)="$event.stopPropagation()"
        (keydown.escape)="closeCreate()"
        tabindex="-1"
      >
        <div class="modal-header">
          <h2>{{ editing() ? 'Edit User' : 'Register New User' }}</h2>
          <button class="modal-close" (click)="closeCreate()">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <form (ngSubmit)="submitCreate()">
          <div class="modal-body">
            <!-- Name Row -->
            <div class="field-row">
              <div class="field">
                <label for="firstName">First Name *</label>
                <input
                  id="firstName"
                  type="text"
                  [(ngModel)]="createForm.firstName"
                  name="firstName"
                  required
                />
              </div>
              <div class="field">
                <label for="lastName">Last Name *</label>
                <input
                  id="lastName"
                  type="text"
                  [(ngModel)]="createForm.lastName"
                  name="lastName"
                  required
                />
              </div>
            </div>

            <!-- Username & Email -->
            <div class="field-row">
              <div class="field">
                <label for="username">Username *</label>
                <input
                  id="username"
                  type="text"
                  [(ngModel)]="createForm.username"
                  name="username"
                  required
                />
              </div>
              <div class="field">
                <label for="email">Email *</label>
                <input
                  id="email"
                  type="email"
                  [(ngModel)]="createForm.email"
                  name="email"
                  required
                />
              </div>
            </div>

            <!-- Password & Phone -->
            <div class="field-row">
              <div class="field">
                <label for="password">Password *</label>
                <input
                  id="password"
                  type="password"
                  [(ngModel)]="createForm.password"
                  name="password"
                  required
                />
              </div>
              <div class="field">
                <label for="phoneNumber">Phone Number *</label>
                <input
                  id="phoneNumber"
                  type="tel"
                  [(ngModel)]="createForm.phoneNumber"
                  name="phoneNumber"
                  required
                  placeholder="+226 70 00 00 00"
                />
              </div>
            </div>

            <!-- Roles (multi-select checkboxes) -->
            <fieldset class="field">
              <legend>Roles *</legend>
              <div class="role-checkbox-group">
                @for (role of availableRoles(); track role.id) {
                  <label class="role-checkbox">
                    <input
                      type="checkbox"
                      [checked]="selectedRoles.includes(role.code)"
                      (change)="onRoleToggle(role.code, $any($event.target).checked)"
                    />
                    <span class="role-label">{{ role.name || role.code }}</span>
                  </label>
                }
                @if (availableRoles().length === 0) {
                  <span class="hint-text">Loading roles...</span>
                }
              </div>
            </fieldset>

            <!-- License Number (conditional) -->
            @if (licenseRequired) {
              <div class="field">
                <label for="licenseNumber">License Number *</label>
                <input
                  id="licenseNumber"
                  type="text"
                  [(ngModel)]="createForm.licenseNumber"
                  name="licenseNumber"
                  required
                  placeholder="Medical license number"
                />
                <span class="hint-text"
                  >Required for medical roles (Doctor, Nurse, Lab Scientist, Pharmacist)</span
                >
              </div>
            }

            <!-- Hospital -->
            <div class="field">
              <label for="hospitalId">Hospital</label>
              <select id="hospitalId" [(ngModel)]="createForm.hospitalId" name="hospitalId">
                <option value="">— None —</option>
                @for (h of availableHospitals(); track h.id) {
                  <option [value]="h.id">{{ h.name }}</option>
                }
              </select>
            </div>

            <!-- Job Title & Employment Type -->
            <div class="field-row">
              <div class="field">
                <label for="jobTitle">Job Title</label>
                <select id="jobTitle" [(ngModel)]="createForm.jobTitle" name="jobTitle">
                  <option value="">— Select —</option>
                  @for (jt of jobTitles; track jt) {
                    <option [value]="jt">{{ formatEnumLabel(jt) }}</option>
                  }
                </select>
              </div>
              <div class="field">
                <label for="employmentType">Employment Type</label>
                <select
                  id="employmentType"
                  [(ngModel)]="createForm.employmentType"
                  name="employmentType"
                >
                  <option value="">— Select —</option>
                  @for (et of employmentTypes; track et) {
                    <option [value]="et">{{ formatEnumLabel(et) }}</option>
                  }
                </select>
              </div>
            </div>

            <!-- Specialization -->
            <div class="field">
              <label for="specialization">Specialization</label>
              <select
                id="specialization"
                [(ngModel)]="createForm.specialization"
                name="specialization"
              >
                <option value="">— Select —</option>
                @for (sp of specializations; track sp) {
                  <option [value]="sp">{{ formatEnumLabel(sp) }}</option>
                }
              </select>
            </div>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn-secondary" (click)="closeCreate()">Cancel</button>
            <button type="submit" class="btn-primary" [disabled]="saving()">
              {{ saving() ? 'Saving...' : (editing() ? 'Update' : 'Register') }}
            </button>
          </div>
        </form>
      </dialog>
    </div>
  }

  <!-- Delete Confirmation Modal -->
  @if (showDeleteConfirm()) {
    <div class="modal-backdrop" (click)="cancelDelete()" (keydown.escape)="cancelDelete()" tabindex="-1">
      <dialog class="modal" [open]="showDeleteConfirm()" (click)="$event.stopPropagation()" (keydown.escape)="cancelDelete()" tabindex="-1">
        <div class="modal-header">
          <h2>Delete User</h2>
          <button class="modal-close" (click)="cancelDelete()">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="delete-warning">
            <span class="material-symbols-outlined warning-icon">warning</span>
            <p>Are you sure you want to delete <strong>{{ deletingUser()?.firstName }} {{ deletingUser()?.lastName }}</strong>?</p>
            <p class="delete-detail">This will permanently remove this user account and all associated data.</p>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="cancelDelete()">Cancel</button>
          <button type="button" class="btn-danger" [disabled]="deleting()" (click)="executeDelete()">
            {{ deleting() ? 'Deleting...' : 'Delete' }}
          </button>
        </div>
      </dialog>
    </div>
  }
</div>
