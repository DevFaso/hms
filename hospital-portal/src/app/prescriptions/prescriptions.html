<div class="page-container">
  <div class="page-header">
    <div>
      <h1 class="page-title">Prescriptions</h1>
      <p class="page-subtitle">Medication orders and prescription management</p>
    </div>
    <div class="page-actions">
      <button class="btn-primary" (click)="openCreate()">
        <span class="material-symbols-outlined">add</span> New Prescription
      </button>
    </div>
  </div>
  <div class="summary-cards">
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon active">medication</span>
      <div class="card-info">
        <span class="card-value">{{ countByStatus('ACTIVE') }}</span
        ><span class="card-label">Active</span>
      </div>
    </div>
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon completed">check_circle</span>
      <div class="card-info">
        <span class="card-value">{{ countByStatus('COMPLETED') }}</span
        ><span class="card-label">Completed</span>
      </div>
    </div>
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon cancelled">cancel</span>
      <div class="card-info">
        <span class="card-value">{{ countByStatus('CANCELLED') }}</span
        ><span class="card-label">Cancelled</span>
      </div>
    </div>
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon total">bar_chart</span>
      <div class="card-info">
        <span class="card-value">{{ prescriptions().length }}</span
        ><span class="card-label">Total</span>
      </div>
    </div>
  </div>
  <div class="filter-bar">
    <div class="tabs">
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'all'"
        (click)="setTab('all')"
        title="Show all"
      >
        All
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'active'"
        (click)="setTab('active')"
        title="Show active"
      >
        Active
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'completed'"
        (click)="setTab('completed')"
        title="Show completed"
      >
        Completed
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'cancelled'"
        (click)="setTab('cancelled')"
        title="Show cancelled"
      >
        Cancelled
      </button>
    </div>
    <div class="search-box">
      <span class="material-symbols-outlined">search</span
      ><input
        type="text"
        placeholder="Search prescriptions..."
        [(ngModel)]="searchTerm"
        (input)="applyFilter()"
      />
    </div>
  </div>
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading prescriptions...</p>
    </div>
  }
  @if (!loading() && filtered().length === 0) {
    <div class="empty-state">
      <span class="material-symbols-outlined empty-icon">medication</span>
      <h3>No prescriptions found</h3>
      <p>Prescriptions will appear here.</p>
    </div>
  }
  @if (!loading() && filtered().length > 0) {
    <div class="data-table">
      <table>
        <thead>
          <tr>
            <th scope="col">Patient</th>
            <th scope="col">Medication</th>
            <th scope="col">Dosage</th>
            <th scope="col">Frequency</th>
            <th scope="col">Duration</th>
            <th scope="col">Prescribed By</th>
            <th scope="col">Status</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (p of filtered(); track p.id) {
            <tr class="data-row">
              <td>
                <div class="cell-primary">{{ p.patientFullName || 'Unknown' }}</div>
              </td>
              <td>
                <strong>{{ p.medicationDisplayName || p.medicationName }}</strong>
              </td>
              <td>{{ p.dosage || '—' }}</td>
              <td>{{ p.frequency || '—' }}</td>
              <td>{{ p.duration || '—' }}</td>
              <td>{{ p.staffFullName || '—' }}</td>
              <td>
                <span class="status-badge {{ getStatusClass(p.status) }}">{{ p.status }}</span>
              </td>
              <td>
                <div class="action-group">
                  <button
                    class="action-link view-link"
                    (click)="viewDetail(p)"
                    title="View prescription details"
                  >
                    <span class="material-symbols-outlined">visibility</span>
                  </button>
                  <button class="action-link edit-link" (click)="openEdit(p)" title="Edit">
                    <span class="material-symbols-outlined">edit</span>
                  </button>
                  <button class="action-link delete-link" (click)="confirmDelete(p)" title="Delete">
                    <span class="material-symbols-outlined">delete</span>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
  @if (selectedPrescription(); as rx) {
    <div class="detail-overlay" tabindex="-1" (keydown.escape)="closeDetail()">
      <div class="detail-panel">
        <div class="detail-header">
          <h2>Prescription Details</h2>
          <button class="btn-close" (click)="closeDetail()" title="Close detail panel">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <div class="detail-body">
          <div class="detail-grid">
            <div class="detail-field">
              <span class="field-label">Patient</span
              ><span class="field-value">{{ rx.patientFullName }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Medication</span
              ><span class="field-value">{{ rx.medicationDisplayName || rx.medicationName }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Dosage</span
              ><span class="field-value">{{ rx.dosage || '—' }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Frequency</span
              ><span class="field-value">{{ rx.frequency || '—' }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Duration</span
              ><span class="field-value">{{ rx.duration || '—' }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Status</span
              ><span class="field-value"
                ><span class="status-badge {{ getStatusClass(rx.status) }}">{{
                  rx.status
                }}</span></span
              >
            </div>
            <div class="detail-field">
              <span class="field-label">Prescribed By</span
              ><span class="field-value">{{ rx.staffFullName || '—' }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Created</span
              ><span class="field-value">{{
                rx.createdAt ? (rx.createdAt | date: 'medium') : '—'
              }}</span>
            </div>
          </div>
          @if (rx.notes) {
            <div class="detail-notes">
              <span class="field-label">Notes</span>
              <p>{{ rx.notes }}</p>
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>

<!-- ═══ CREATE / EDIT PRESCRIPTION MODAL ═══ -->
@if (showModal()) {
  <div class="modal-backdrop" tabindex="-1" (click)="closeModal()" (keydown.escape)="closeModal()">
    <div
      class="modal modal-lg"
      tabindex="-1"
      (click)="$event.stopPropagation()"
      (keydown.escape)="$event.stopPropagation()"
    >
      <div class="modal-header">
        <h2>{{ editing() ? 'Edit Prescription' : 'New Prescription' }}</h2>
        <button class="modal-close" (click)="closeModal()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="field">
            <label for="rx-patientSearch">Patient *</label>
            @if (selectedPatient()) {
              <div class="picker-chip">
                <div class="chip-avatar">{{ patientInitials(selectedPatient()!) }}</div>
                <div class="chip-info">
                  <span class="chip-name"
                    >{{ selectedPatient()!.firstName }} {{ selectedPatient()!.lastName }}</span
                  >
                  <span class="chip-sub">{{ selectedPatient()!.email }}</span>
                </div>
                <button
                  type="button"
                  class="chip-clear"
                  (click)="clearPatient()"
                  title="Change patient"
                >
                  <span class="material-symbols-outlined">close</span>
                </button>
              </div>
            } @else {
              <div class="patient-picker-wrap">
                <span class="material-symbols-outlined picker-search-icon">person_search</span>
                <input
                  id="rx-patientSearch"
                  class="picker-input"
                  type="text"
                  placeholder="Search by name, email or MRN…"
                  [value]="patientQuery()"
                  (input)="onPatientQueryChange($any($event.target).value)"
                  (blur)="patientDropdownOpen.set(false)"
                  autocomplete="off"
                />
                @if (patientSearchLoading()) {
                  <div class="picker-spinner"></div>
                }
                @if (patientDropdownOpen()) {
                  <ul class="picker-dropdown" aria-label="Patient suggestions">
                    @for (p of patientSuggestions(); track p.id) {
                      <li class="picker-option" (mousedown)="selectPatient(p)">
                        <div class="opt-avatar">{{ patientInitials(p) }}</div>
                        <div class="opt-info">
                          <span class="opt-name">{{ p.firstName }} {{ p.lastName }}</span>
                          <span class="opt-meta"
                            >{{ p.email }}{{ p.mrn ? ' · MRN ' + p.mrn : '' }}</span
                          >
                        </div>
                      </li>
                    }
                  </ul>
                }
              </div>
            }
          </div>
          <div class="field">
            <label for="rx-staffId">Prescriber</label>
            <select id="rx-staffId" [(ngModel)]="form.staffId">
              <option value="">Select prescriber...</option>
              @for (s of staffMembers(); track s.id) {
                <option [value]="s.id">{{ s.name }}</option>
              }
            </select>
          </div>
        </div>
        <div class="field">
          <label for="rx-medName">Medication Name *</label>
          <input
            id="rx-medName"
            type="text"
            [(ngModel)]="form.medicationName"
            placeholder="e.g. Amoxicillin 500mg"
            required
          />
        </div>
        <div class="form-row">
          <div class="field">
            <label for="rx-dosage">Dosage</label>
            <input id="rx-dosage" type="text" [(ngModel)]="form.dosage" placeholder="e.g. 500mg" />
          </div>
          <div class="field">
            <label for="rx-frequency">Frequency</label>
            <input
              id="rx-frequency"
              type="text"
              [(ngModel)]="form.frequency"
              placeholder="e.g. 3x daily"
            />
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label for="rx-duration">Duration</label>
            <input
              id="rx-duration"
              type="text"
              [(ngModel)]="form.duration"
              placeholder="e.g. 7 days"
            />
          </div>
          <div class="field">
            <label for="rx-encounterId">Encounter ID</label>
            <input
              id="rx-encounterId"
              type="text"
              [(ngModel)]="form.encounterId"
              placeholder="Optional"
            />
          </div>
        </div>
        <div class="field">
          <label for="rx-notes">Notes</label>
          <textarea
            id="rx-notes"
            [(ngModel)]="form.notes"
            rows="3"
            placeholder="Prescription notes..."
          ></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeModal()">Cancel</button>
        <button
          class="btn-primary"
          (click)="submitForm()"
          [disabled]="saving() || !form.medicationName"
        >
          {{ saving() ? 'Saving...' : editing() ? 'Update' : 'Create' }}
        </button>
      </div>
    </div>
  </div>
}

<!-- ═══ DELETE CONFIRM ═══ -->
@if (showDeleteConfirm()) {
  <div
    class="modal-backdrop"
    tabindex="-1"
    (click)="cancelDelete()"
    (keydown.escape)="cancelDelete()"
  >
    <div
      class="modal"
      tabindex="-1"
      (click)="$event.stopPropagation()"
      (keydown.escape)="$event.stopPropagation()"
    >
      <div class="modal-header">
        <h2>Delete Prescription</h2>
        <button class="modal-close" (click)="cancelDelete()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="modal-body">
        <p class="delete-warning">
          Are you sure you want to delete the prescription for
          <strong>{{ deletingRx()?.medicationName }}</strong
          >? This action cannot be undone.
        </p>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" (click)="cancelDelete()">Cancel</button>
        <button class="btn-danger" (click)="executeDelete()" [disabled]="deleting()">
          {{ deleting() ? 'Deleting...' : 'Delete' }}
        </button>
      </div>
    </div>
  </div>
}
