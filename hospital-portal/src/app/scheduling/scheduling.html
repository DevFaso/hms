<div class="page-container">
  <div class="page-header">
    <div class="page-title-group">
      <h1>
        <span class="material-symbols-outlined">calendar_month</span>
        Staff Scheduling
      </h1>
      <p class="subtitle">Manage shifts, schedules, and leave requests</p>
    </div>
    <div class="page-actions">
      <button class="btn-primary" (click)="openBulkModal()">
        <span class="material-symbols-outlined">date_range</span>
        Bulk Schedule
      </button>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="summary-row">
    <div class="summary-card shifts-card">
      <span class="material-symbols-outlined">event_note</span>
      <div class="summary-info">
        <span class="summary-value">{{ shifts().length }}</span>
        <span class="summary-label">Shifts This Week</span>
      </div>
    </div>
    <div class="summary-card pending-card">
      <span class="material-symbols-outlined">hourglass_top</span>
      <div class="summary-info">
        <span class="summary-value">{{ pendingCount }}</span>
        <span class="summary-label">Pending Leaves</span>
      </div>
    </div>
    <div class="summary-card approved-card">
      <span class="material-symbols-outlined">check_circle</span>
      <div class="summary-info">
        <span class="summary-value">{{ approvedCount }}</span>
        <span class="summary-label">Approved Leaves</span>
      </div>
    </div>
    <div class="summary-card total-card">
      <span class="material-symbols-outlined">groups</span>
      <div class="summary-info">
        <span class="summary-value">{{ leaves().length }}</span>
        <span class="summary-label">Total Leave Requests</span>
      </div>
    </div>
  </div>

  <!-- View Toggle -->
  <div class="tabs">
    <button class="tab" [class.active]="activeView() === 'shifts'" (click)="setView('shifts')">
      <span class="material-symbols-outlined">event_note</span>
      Shifts
    </button>
    <button class="tab" [class.active]="activeView() === 'leaves'" (click)="setView('leaves')">
      <span class="material-symbols-outlined">event_busy</span>
      Leave Requests
      @if (pendingCount > 0) {
        <span class="badge">{{ pendingCount }}</span>
      }
    </button>
  </div>

  <!-- ═══ SHIFTS VIEW ═══ -->
  @if (activeView() === 'shifts') {
    <div class="schedule-section">
      <div class="schedule-header">
        <h3>
          <span class="material-symbols-outlined">view_week</span>
          Weekly Schedule
        </h3>
        <div class="week-nav">
          <button class="week-btn" (click)="changeWeek(-1)" aria-label="Previous week">
            <span class="material-symbols-outlined">chevron_left</span>
          </button>
          <button class="week-label" (click)="goToCurrentWeek()" title="Go to current week">
            {{ getWeekLabel() }}
          </button>
          <button class="week-btn" (click)="changeWeek(1)" aria-label="Next week">
            <span class="material-symbols-outlined">chevron_right</span>
          </button>
        </div>
      </div>

      @if (shiftsLoading()) {
        <div class="schedule-loading">
          <div class="spinner-sm"></div>
          <span>Loading shifts...</span>
        </div>
      } @else {
        <div class="week-grid">
          @for (day of getWeekDays(); track day.date) {
            <div class="day-column" [class.today]="day.isToday">
              <div class="day-header">
                <span class="day-name">{{ day.label }}</span>
                <span class="day-date">{{ formatShortDate(day.date) }}</span>
              </div>
              <div class="day-shifts">
                @for (shift of getShiftsForDay(day.date); track shift.id) {
                  <div
                    class="shift-card"
                    [attr.data-type]="shift.shiftType"
                    [attr.data-status]="shift.status"
                    [class.cross-midnight]="shift.crossMidnight"
                    [class.cross-midnight-end]="
                      shift.crossMidnight && shift.shiftEndDate === day.date
                    "
                  >
                    <div class="shift-avatar">{{ getInitials(shift.staffName) }}</div>
                    <div class="shift-info">
                      <span class="shift-staff-name">{{ shift.staffName }}</span>
                      <span class="shift-time">{{ formatShiftRange(shift) }}</span>
                      @if (shift.crossMidnight && shift.shiftEndDate === day.date) {
                        <span class="cross-midnight-badge">← cont'd</span>
                      }
                      <span class="shift-meta">
                        <span class="material-symbols-outlined">{{
                          shiftTypeIcon(shift.shiftType)
                        }}</span>
                        {{ formatShiftType(shift.shiftType) }}
                      </span>
                    </div>
                    <span class="shift-status-badge" [attr.data-status]="shift.status">
                      {{ shift.status }}
                    </span>
                  </div>
                } @empty {
                  <div class="no-shift">No shifts</div>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- ═══ LEAVES VIEW ═══ -->
  @if (activeView() === 'leaves') {
    <div class="filter-bar">
      <button
        class="filter-chip"
        [class.active]="leaveFilter() === 'ALL'"
        (click)="setLeaveFilter('ALL')"
      >
        All
      </button>
      <button
        class="filter-chip pending"
        [class.active]="leaveFilter() === 'PENDING'"
        (click)="setLeaveFilter('PENDING')"
      >
        Pending
      </button>
      <button
        class="filter-chip approved"
        [class.active]="leaveFilter() === 'APPROVED'"
        (click)="setLeaveFilter('APPROVED')"
      >
        Approved
      </button>
      <button
        class="filter-chip denied"
        [class.active]="leaveFilter() === 'DENIED'"
        (click)="setLeaveFilter('DENIED')"
      >
        Denied
      </button>
      <button
        class="filter-chip cancelled"
        [class.active]="leaveFilter() === 'CANCELLED'"
        (click)="setLeaveFilter('CANCELLED')"
      >
        Cancelled
      </button>
    </div>

    @if (leavesLoading()) {
      <div class="schedule-loading">
        <div class="spinner-sm"></div>
        <span>Loading leave requests...</span>
      </div>
    } @else if (filteredLeaves().length === 0) {
      <div class="empty-schedule">
        <span class="material-symbols-outlined">event_available</span>
        <h3>No leave requests</h3>
        <p>No leave requests found matching the selected filter.</p>
      </div>
    } @else {
      <div class="leave-list">
        @for (leave of filteredLeaves(); track leave.id) {
          <div class="leave-card" [attr.data-status]="leave.status">
            <div class="leave-icon">
              <span class="material-symbols-outlined">{{ leaveTypeIcon(leave.leaveType) }}</span>
            </div>
            <div class="leave-details">
              <div class="leave-title-row">
                <span class="leave-staff-name">{{ leave.staffName }}</span>
                <span class="leave-type-label">{{ formatLeaveType(leave.leaveType) }}</span>
                <span class="leave-status-badge" [attr.data-status]="leave.status">{{
                  leave.status
                }}</span>
              </div>
              <div class="leave-dates">
                <span class="material-symbols-outlined">date_range</span>
                {{ formatDate(leave.startDate) }}
                @if (leave.startDate !== leave.endDate) {
                  <span>&nbsp;→&nbsp;</span>{{ formatDate(leave.endDate) }}
                }
              </div>
              @if (leave.startTime && leave.endTime) {
                <div class="leave-times">
                  <span class="material-symbols-outlined">schedule</span>
                  {{ formatTime(leave.startTime) }} – {{ formatTime(leave.endTime) }}
                </div>
              }
              @if (leave.reason) {
                <div class="leave-reason">
                  <span class="material-symbols-outlined">notes</span>
                  {{ leave.reason }}
                </div>
              }
              @if (leave.requiresCoverage) {
                <span class="coverage-badge">
                  <span class="material-symbols-outlined">swap_horiz</span>
                  Coverage Required
                </span>
              }
            </div>
            <div class="leave-right">
              @if (leave.departmentName) {
                <span class="leave-dept">{{ leave.departmentName }}</span>
              }
              @if (leave.reviewedByName) {
                <span class="reviewed-by">Reviewed: {{ leave.reviewedByName }}</span>
              }
              @if (leave.managerNote) {
                <span class="manager-note">"{{ leave.managerNote }}"</span>
              }
            </div>
          </div>
        }
      </div>
    }
  }
</div>

<!-- ═══ BULK SCHEDULE MODAL ═══ -->
@if (bulkModalOpen()) {
  <dialog class="modal-panel" open aria-labelledby="bulk-modal-title">
    <!-- Header -->
    <div class="modal-header">
      <div class="modal-title-group">
        <span class="material-symbols-outlined modal-icon">date_range</span>
        <div>
          <h2 id="bulk-modal-title" class="modal-title">Bulk Schedule Shifts</h2>
          <p class="modal-subtitle">Schedule recurring shifts over a date range by day of week</p>
        </div>
      </div>
      <button class="modal-close" (click)="closeBulkModal()" aria-label="Close bulk schedule modal">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <!-- Body -->
    <div class="modal-body">
      <!-- Staff Search + Hospital (auto-filled) -->
      <div class="form-row">
        <!-- ── Staff picker ── -->
        <div class="form-group">
          <label class="form-label" for="bulk-staffSearch">
            <span class="material-symbols-outlined">badge</span>
            Staff Member <span class="required">*</span>
          </label>

          @if (selectedStaff()) {
            <!-- Selected chip -->
            <div class="selected-chip">
              <span class="chip-avatar">{{ staffInitials(selectedStaff()!) }}</span>
              <div class="chip-info">
                <span class="chip-name">{{ selectedStaff()!.name }}</span>
                <span class="chip-sub">{{
                  selectedStaff()!.jobTitle ?? selectedStaff()!.roleName ?? 'Staff'
                }}</span>
              </div>
              <button
                class="chip-clear"
                type="button"
                (click)="clearStaff()"
                aria-label="Clear selected staff"
              >
                <span class="material-symbols-outlined">close</span>
              </button>
            </div>
          } @else {
            <!-- Search input + suggestions dropdown -->
            <div class="staff-search-wrap">
              <span class="material-symbols-outlined search-icon">search</span>
              <input
                id="bulk-staffSearch"
                class="form-input staff-search-input"
                type="text"
                placeholder="Search by name, role or hospital…"
                [value]="staffQuery()"
                (input)="onStaffQueryChange($any($event.target).value)"
                (blur)="closeSuggestions()"
                autocomplete="off"
              />
              @if (staffLoading()) {
                <span class="search-spinner"></span>
              }
              @if (staffSuggestionsOpen()) {
                <ul class="suggestions-dropdown" aria-label="Staff suggestions">
                  @for (s of staffSuggestions(); track s.id) {
                    <li class="suggestion-item" (mousedown)="selectStaff(s)">
                      <span class="sug-avatar">{{ staffInitials(s) }}</span>
                      <div class="sug-info">
                        <span class="sug-name">{{ s.name }}</span>
                        <span class="sug-meta">
                          {{ s.jobTitle ?? s.roleName ?? 'Staff' }}
                          @if (s.departmentName) {
                            &nbsp;·&nbsp; {{ s.departmentName }}
                          }
                        </span>
                        <span class="sug-hospital">
                          <span class="material-symbols-outlined">local_hospital</span>
                          {{ s.hospitalName ?? 'Unknown hospital' }}
                        </span>
                      </div>
                    </li>
                  }
                </ul>
              }
            </div>
          }
        </div>

        <!-- ── Hospital (auto-filled or manual fallback) ── -->
        <div class="form-group">
          <label class="form-label" for="bulk-hospitalId">
            <span class="material-symbols-outlined">local_hospital</span>
            Hospital <span class="required">*</span>
          </label>

          @if (selectedStaff()) {
            <!-- Read-only chip showing the matched hospital -->
            <div class="hospital-locked">
              <span class="material-symbols-outlined lock-icon">lock</span>
              <div class="locked-info">
                <span class="locked-name">{{ selectedStaff()!.hospitalName ?? 'Hospital' }}</span>
                <span class="locked-sub"
                  >Auto-matched from staff ·
                  <span class="uuid-pill"
                    >{{ selectedStaff()!.hospitalId | slice: 0 : 8 }}…</span
                  ></span
                >
              </div>
            </div>
          } @else {
            <input
              id="bulk-hospitalId"
              class="form-input"
              type="text"
              placeholder="Paste hospital UUID"
              [(ngModel)]="bulk.hospitalId"
            />
          }
        </div>
      </div>

      <!-- Date Range -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="bulk-startDate">
            <span class="material-symbols-outlined">today</span>
            Start Date <span class="required">*</span>
          </label>
          <input id="bulk-startDate" class="form-input" type="date" [(ngModel)]="bulk.startDate" />
        </div>
        <div class="form-group">
          <label class="form-label" for="bulk-endDate">
            <span class="material-symbols-outlined">event</span>
            End Date <span class="required">*</span>
          </label>
          <input id="bulk-endDate" class="form-input" type="date" [(ngModel)]="bulk.endDate" />
        </div>
      </div>

      <!-- Times + Shift Type -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="bulk-startTime">
            <span class="material-symbols-outlined">schedule</span>
            Start Time <span class="required">*</span>
          </label>
          <input id="bulk-startTime" class="form-input" type="time" [(ngModel)]="bulk.startTime" />
        </div>
        <div class="form-group">
          <label class="form-label" for="bulk-endTime">
            <span class="material-symbols-outlined">schedule</span>
            End Time <span class="required">*</span>
            <span class="form-hint">(can be next day)</span>
          </label>
          <input id="bulk-endTime" class="form-input" type="time" [(ngModel)]="bulk.endTime" />
        </div>
        <div class="form-group">
          <label class="form-label" for="bulk-shiftType">
            <span class="material-symbols-outlined">brightness_4</span>
            Shift Type <span class="required">*</span>
          </label>
          <select id="bulk-shiftType" class="form-input form-select" [(ngModel)]="bulk.shiftType">
            <option value="MORNING">Morning</option>
            <option value="AFTERNOON">Afternoon</option>
            <option value="EVENING">Evening</option>
            <option value="NIGHT">Night</option>
            <option value="ON_CALL">On Call</option>
            <option value="FLEX">Flex</option>
          </select>
        </div>
      </div>

      <!-- Days of Week -->
      <fieldset class="form-group form-group--full dow-fieldset">
        <legend class="form-label">
          <span class="material-symbols-outlined">view_week</span>
          Days of Week <span class="required">*</span>
        </legend>
        <div class="dow-presets">
          <button type="button" class="dow-preset-btn" (click)="selectWeekdays()">Mon–Fri</button>
          <button type="button" class="dow-preset-btn" (click)="selectWeekend()">Sat–Sun</button>
          <button type="button" class="dow-preset-btn" (click)="selectAllDays()">All days</button>
        </div>
        <div class="dow-grid">
          @for (day of allDays; track day) {
            <button
              type="button"
              class="dow-chip"
              [class.selected]="isDaySelected(day)"
              [attr.aria-pressed]="isDaySelected(day)"
              (click)="toggleDay(day)"
            >
              {{ day.slice(0, 3) }}
            </button>
          }
        </div>
      </fieldset>

      <!-- Notes -->
      <div class="form-group form-group--full">
        <label class="form-label" for="bulk-notes">
          <span class="material-symbols-outlined">notes</span>
          Notes (optional)
        </label>
        <input
          id="bulk-notes"
          class="form-input"
          type="text"
          placeholder="Applied to every generated shift"
          [(ngModel)]="bulk.notes"
        />
      </div>

      <!-- Skip Conflicts Toggle -->
      <div class="form-group form-group--full toggle-row">
        <p class="toggle-description">
          <span class="material-symbols-outlined">skip_next</span>
          <span>
            Skip conflicting dates
            <span class="toggle-hint">
              Dates with overlapping shifts or leave will be silently skipped instead of aborting
            </span>
          </span>
        </p>
        <div class="toggle-switch">
          <input
            id="bulk-skip"
            type="checkbox"
            aria-label="Skip conflicting dates"
            [(ngModel)]="bulk.skipConflicts"
          />
          <span class="toggle-track" aria-hidden="true">
            <span class="toggle-thumb"></span>
          </span>
        </div>
      </div>

      <!-- Result Summary (shown after submit) -->
      @if (bulkResult()) {
        <div class="bulk-result">
          <div class="bulk-result-stats">
            <div class="bulk-stat scheduled">
              <span class="material-symbols-outlined">check_circle</span>
              <span class="bulk-stat-val">{{ bulkResult()!.totalScheduled }}</span>
              <span class="bulk-stat-lbl">Scheduled</span>
            </div>
            <div class="bulk-stat skipped">
              <span class="material-symbols-outlined">cancel</span>
              <span class="bulk-stat-val">{{ bulkResult()!.totalSkipped }}</span>
              <span class="bulk-stat-lbl">Skipped</span>
            </div>
          </div>
          @if (bulkResult()!.skipped.length > 0) {
            <div class="bulk-skipped-list">
              <h4 class="bulk-skipped-title">Skipped dates</h4>
              @for (skip of bulkResult()!.skipped; track skip.date) {
                <div class="bulk-skip-row">
                  <span class="material-symbols-outlined skip-icon">event_busy</span>
                  <span class="skip-date">{{ formatDate(skip.date) }}</span>
                  <span class="skip-reason">{{ skip.reason }}</span>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>

    <!-- Footer -->
    <div class="modal-footer">
      <button class="btn-ghost" (click)="closeBulkModal()">Cancel</button>
      <button class="btn-primary" (click)="submitBulk()" [disabled]="bulkSubmitting()">
        @if (bulkSubmitting()) {
          <span class="spinner-sm"></span>
          Scheduling…
        } @else {
          <span class="material-symbols-outlined">bolt</span>
          Generate Shifts
        }
      </button>
    </div>
  </dialog>
}
