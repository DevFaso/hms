<div class="page-container">
  <a routerLink="/appointments" class="back-link">
    <span class="material-symbols-outlined">arrow_back</span>
    Back to Appointments
  </a>

  <div class="form-card">
    <div class="form-header">
      <span class="material-symbols-outlined form-icon">event</span>
      <div>
        <h1>New Appointment</h1>
        <p>Schedule a new patient appointment</p>
      </div>
    </div>

    <form (ngSubmit)="submit()" #apptForm="ngForm">
      <div class="form-grid">
        <!-- Date & Time -->
        <div class="form-section">
          <h3>Date & Time</h3>
          <div class="field-row">
            <div class="field">
              <label for="date">Appointment Date *</label>
              <input
                id="date"
                type="date"
                [(ngModel)]="form.appointmentDate"
                name="appointmentDate"
                required
              />
            </div>
          </div>
          <div class="field-row two-col">
            <div class="field">
              <label for="start">Start Time *</label>
              <input
                id="start"
                type="time"
                [(ngModel)]="form.startTime"
                name="startTime"
                required
                (change)="onStartTimeChange()"
              />
            </div>
            <div class="field">
              <label for="end">End Time *</label>
              <input
                id="end"
                type="time"
                [(ngModel)]="form.endTime"
                name="endTime"
                required
                (change)="onEndTimeChange()"
              />
            </div>
          </div>
          @if (timeError()) {
            <p class="field-error">
              <span class="material-symbols-outlined">error</span>
              {{ timeError() }}
            </p>
          }
        </div>

        <!-- Patient picker -->
        <div class="form-section">
          <h3>Patient *</h3>
          @if (selectedPatient()) {
            <div class="picker-chip">
              <div class="chip-avatar">{{ patientInitials(selectedPatient()!) }}</div>
              <div class="chip-info">
                <span class="chip-name"
                  >{{ selectedPatient()!.firstName }} {{ selectedPatient()!.lastName }}</span
                >
                <span class="chip-sub"
                  >{{ selectedPatient()!.email
                  }}{{ selectedPatient()!.mrn ? ' · MRN ' + selectedPatient()!.mrn : '' }}</span
                >
              </div>
              <button
                type="button"
                class="chip-clear"
                (click)="clearPatient()"
                title="Change patient"
              >
                <span class="material-symbols-outlined">close</span>
              </button>
            </div>
          } @else {
            <div class="patient-picker-wrap">
              <span class="material-symbols-outlined picker-search-icon">person_search</span>
              <input
                class="picker-input"
                type="text"
                placeholder="Search by name, email or MRN…"
                [value]="patientQuery()"
                (input)="onPatientQueryChange($any($event.target).value)"
                (blur)="patientDropdownOpen.set(false)"
                autocomplete="off"
              />
              @if (patientSearchLoading()) {
                <div class="picker-spinner"></div>
              }
              @if (patientDropdownOpen()) {
                <ul class="picker-dropdown" aria-label="Patient suggestions">
                  @for (p of patientSuggestions(); track p.id) {
                    <li class="picker-option" (mousedown)="selectPatient(p)">
                      <div class="opt-avatar">{{ patientInitials(p) }}</div>
                      <div class="opt-info">
                        <span class="opt-name">{{ p.firstName }} {{ p.lastName }}</span>
                        <span class="opt-meta"
                          >{{ p.email }}{{ p.mrn ? ' · MRN ' + p.mrn : '' }}</span
                        >
                      </div>
                    </li>
                  }
                </ul>
              }
            </div>
          }
        </div>

        <!-- Staff / Doctor picker -->
        <div class="form-section">
          <h3>Doctor / Staff *</h3>
          @if (selectedStaff()) {
            <div class="picker-chip staff-chip">
              <div class="chip-avatar staff-avatar">{{ staffInitials(selectedStaff()!) }}</div>
              <div class="chip-info">
                <span class="chip-name">{{ selectedStaff()!.name }}</span>
                <span class="chip-sub"
                  >{{ selectedStaff()!.jobTitle
                  }}{{
                    selectedStaff()!.hospitalName ? ' · ' + selectedStaff()!.hospitalName : ''
                  }}</span
                >
              </div>
              <button
                type="button"
                class="chip-clear"
                (click)="clearStaff()"
                title="Change staff member"
              >
                <span class="material-symbols-outlined">close</span>
              </button>
            </div>
          } @else {
            <div class="patient-picker-wrap">
              <span class="material-symbols-outlined picker-search-icon">badge</span>
              <input
                class="picker-input"
                type="text"
                placeholder="Search doctor or staff by name…"
                [value]="staffQuery()"
                (input)="onStaffQueryChange($any($event.target).value)"
                (blur)="staffDropdownOpen.set(false)"
                autocomplete="off"
              />
              @if (staffSearchLoading()) {
                <div class="picker-spinner"></div>
              }
              @if (staffDropdownOpen()) {
                <ul class="picker-dropdown" aria-label="Staff suggestions">
                  @for (s of staffSuggestions(); track s.id) {
                    <li class="picker-option" (mousedown)="selectStaff(s)">
                      <div class="opt-avatar staff-avatar">{{ staffInitials(s) }}</div>
                      <div class="opt-info">
                        <span class="opt-name">{{ s.name }}</span>
                        <span class="opt-meta"
                          >{{ s.jobTitle }}{{ s.hospitalName ? ' · ' + s.hospitalName : '' }}</span
                        >
                      </div>
                    </li>
                  }
                </ul>
              }
            </div>
          }
        </div>

        <!-- Location -->
        <div class="form-section">
          <h3>Location</h3>
          <div class="field-row two-col">
            <div class="field">
              <label for="hospitalSel">Hospital</label>
              @if (selectedStaff()?.hospitalId) {
                <div class="locked-field">
                  <span class="material-symbols-outlined">lock</span>
                  {{ selectedStaff()!.hospitalName }}
                </div>
              } @else {
                <select
                  id="hospitalSel"
                  [value]="selectedHospitalId()"
                  (change)="onHospitalChange($any($event.target).value)"
                  name="hospital"
                >
                  <option value="">Select hospital…</option>
                  @for (h of hospitals(); track h.id) {
                    <option [value]="h.id">{{ h.name }}</option>
                  }
                </select>
              }
            </div>
            <div class="field">
              <label for="deptSel">Department</label>
              <select id="deptSel" [(ngModel)]="form.departmentId" name="departmentId">
                <option value="">
                  @if (selectedHospitalId() || selectedStaff()?.hospitalId) {
                    Any department
                  } @else {
                    Select hospital first
                  }
                </option>
                @for (d of departments(); track d.id) {
                  <option [value]="d.id">{{ d.name }}</option>
                }
              </select>
            </div>
          </div>
        </div>

        <!-- Details -->
        <div class="form-section full-width">
          <h3>Details</h3>
          <div class="field">
            <label for="reason">Reason for Visit</label>
            <input
              id="reason"
              type="text"
              placeholder="e.g., Annual checkup, Follow-up"
              [(ngModel)]="form.reason"
              name="reason"
            />
          </div>
          <div class="field notes-field">
            <label for="notes">Notes</label>
            <textarea
              id="notes"
              rows="3"
              placeholder="Additional notes..."
              [(ngModel)]="form.notes"
              name="notes"
            ></textarea>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <a routerLink="/appointments" class="btn-secondary">Cancel</a>
        <button type="submit" class="btn-primary" [disabled]="saving()">
          @if (saving()) {
            <span class="mini-spinner"></span>
            Creating...
          } @else {
            <span class="material-symbols-outlined">event_available</span>
            Create Appointment
          }
        </button>
      </div>
    </form>
  </div>
</div>
