<div class="page-container">
  <div class="page-header">
    <div>
      <h1 class="page-title">Referrals</h1>
      <p class="page-subtitle">Patient referral tracking and management</p>
    </div>
    <div class="page-actions">
      <button class="btn-primary" (click)="openCreate()">
        <span class="material-symbols-outlined">add</span> New Referral
      </button>
    </div>
  </div>
  <div class="summary-cards">
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon pending">pending_actions</span>
      <div class="card-info">
        <span class="card-value">{{ countByGroup('pending') }}</span
        ><span class="card-label">Pending</span>
      </div>
    </div>
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon active">sync</span>
      <div class="card-info">
        <span class="card-value">{{ countByGroup('active') }}</span
        ><span class="card-label">Active</span>
      </div>
    </div>
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon completed">check_circle</span>
      <div class="card-info">
        <span class="card-value">{{ countByGroup('completed') }}</span
        ><span class="card-label">Completed</span>
      </div>
    </div>
    <div class="summary-card">
      <span class="material-symbols-outlined card-icon total">bar_chart</span>
      <div class="card-info">
        <span class="card-value">{{ referrals().length }}</span
        ><span class="card-label">Total</span>
      </div>
    </div>
  </div>
  <div class="filter-bar">
    <div class="tabs">
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'all'"
        (click)="setTab('all')"
        title="Show all"
      >
        All
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'pending'"
        (click)="setTab('pending')"
        title="Show pending"
      >
        Pending
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'active'"
        (click)="setTab('active')"
        title="Show active"
      >
        Active
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab() === 'completed'"
        (click)="setTab('completed')"
        title="Show completed"
      >
        Completed
      </button>
    </div>
    <div class="search-box">
      <span class="material-symbols-outlined">search</span
      ><input
        type="text"
        placeholder="Search referrals..."
        [(ngModel)]="searchTerm"
        (input)="applyFilter()"
      />
    </div>
  </div>
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading referrals...</p>
    </div>
  }
  @if (!loading() && filtered().length === 0) {
    <div class="empty-state">
      <span class="material-symbols-outlined empty-icon">send</span>
      <h3>No referrals found</h3>
      <p>Referrals will appear here.</p>
    </div>
  }
  @if (!loading() && filtered().length > 0) {
    <div class="data-table">
      <table>
        <thead>
          <tr>
            <th scope="col">Patient</th>
            <th scope="col">Specialty</th>
            <th scope="col">Referring</th>
            <th scope="col">Receiving</th>
            <th scope="col">Urgency</th>
            <th scope="col">Status</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (r of filtered(); track r.id) {
            <tr class="data-row">
              <td>
                <div class="cell-primary">{{ r.patientName || 'Unknown' }}</div>
                <div class="cell-secondary">{{ r.patientMrn }}</div>
              </td>
              <td>{{ r.targetSpecialty || '—' }}</td>
              <td>{{ r.referringProviderName || '—' }}</td>
              <td>{{ r.receivingProviderName || 'Unassigned' }}</td>
              <td>
                <span class="urgency-badge {{ getUrgencyClass(r.urgency) }}">{{ r.urgency }}</span>
              </td>
              <td>
                <span class="status-badge {{ getStatusClass(r.status) }}">{{ r.status }}</span>
              </td>
              <td>
                <div class="action-group">
                  <button class="action-link" (click)="viewDetail(r)" title="View referral details">
                    <span class="material-symbols-outlined">visibility</span>
                  </button>
                  @if (!['COMPLETED', 'CANCELLED'].includes(r.status)) {
                    <button
                      class="action-link delete"
                      (click)="confirmCancel(r)"
                      title="Cancel referral"
                    >
                      <span class="material-symbols-outlined">cancel</span>
                    </button>
                  }
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
  @if (selectedReferral(); as ref) {
    <div class="detail-overlay" tabindex="-1" (keydown.escape)="closeDetail()">
      <div class="detail-panel">
        <div class="detail-header">
          <h2>Referral Details</h2>
          <button class="btn-close" (click)="closeDetail()" title="Close">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <div class="detail-body">
          <div class="detail-grid">
            <div class="detail-field">
              <span class="field-label">Patient</span
              ><span class="field-value">{{ ref.patientName }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">MRN</span
              ><span class="field-value">{{ ref.patientMrn }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Specialty</span
              ><span class="field-value">{{ ref.targetSpecialty }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Urgency</span
              ><span class="field-value"
                ><span class="urgency-badge {{ getUrgencyClass(ref.urgency) }}">{{
                  ref.urgency
                }}</span></span
              >
            </div>
            <div class="detail-field">
              <span class="field-label">Referring Provider</span
              ><span class="field-value">{{ ref.referringProviderName || '—' }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Receiving Provider</span
              ><span class="field-value">{{ ref.receivingProviderName || 'Unassigned' }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Status</span
              ><span class="field-value"
                ><span class="status-badge {{ getStatusClass(ref.status) }}">{{
                  ref.status
                }}</span></span
              >
            </div>
            <div class="detail-field">
              <span class="field-label">Submitted</span
              ><span class="field-value">{{
                ref.submittedAt ? (ref.submittedAt | date: 'medium') : '—'
              }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Completed</span
              ><span class="field-value">{{
                ref.completedAt ? (ref.completedAt | date: 'medium') : '—'
              }}</span>
            </div>
            <div class="detail-field">
              <span class="field-label">Created</span
              ><span class="field-value">{{
                ref.createdAt ? (ref.createdAt | date: 'medium') : '—'
              }}</span>
            </div>
          </div>
          @if (ref.referralReason) {
            <div class="detail-notes">
              <span class="field-label">Reason</span>
              <p>{{ ref.referralReason }}</p>
            </div>
          }
          @if (ref.clinicalSummary) {
            <div class="detail-notes">
              <span class="field-label">Clinical Summary</span>
              <p>{{ ref.clinicalSummary }}</p>
            </div>
          }
          @if (ref.clinicalIndication) {
            <div class="detail-notes">
              <span class="field-label">Clinical Indication</span>
              <p>{{ ref.clinicalIndication }}</p>
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- Create Referral Modal -->
  @if (showModal()) {
    <div
      class="modal-backdrop"
      tabindex="-1"
      (click)="closeModal()"
      (keydown.escape)="closeModal()"
    ></div>
    <div class="modal modal-lg">
      <div class="modal-header">
        <h2>New Referral</h2>
        <button class="modal-close" (click)="closeModal()" title="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="field">
            @if (selectedPatient()) {
              <label>Patient</label>
              <div class="picker-chip">
                <span class="chip-avatar">{{ patientInitials(selectedPatient()!) }}</span>
                <span class="chip-info">
                  <span class="chip-name"
                    >{{ selectedPatient()!.firstName }} {{ selectedPatient()!.lastName }}</span
                  >
                  <span class="chip-sub">{{
                    selectedPatient()!.mrn || selectedPatient()!.email
                  }}</span>
                </span>
                <button type="button" class="chip-clear" (click)="clearPatient()" title="Remove">
                  ×
                </button>
              </div>
            } @else {
              <label for="ref-patientSearch">Patient *</label>
              <div class="patient-picker-wrap">
                <span class="picker-search-icon material-icons">person_search</span>
                <input
                  id="ref-patientSearch"
                  type="text"
                  class="picker-input"
                  [value]="patientQuery()"
                  (input)="onPatientQueryChange($any($event.target).value)"
                  placeholder="Search by name, email or MRN…"
                  autocomplete="off"
                />
                @if (patientSearchLoading()) {
                  <span class="picker-spinner"></span>
                }
                @if (patientDropdownOpen()) {
                  <ul class="picker-dropdown" aria-label="Patient suggestions">
                    @for (p of patientSuggestions(); track p.id) {
                      <li class="picker-option" (click)="selectPatient(p)">
                        <span class="opt-avatar">{{ patientInitials(p) }}</span>
                        <span class="opt-info">
                          <span class="opt-name">{{ p.firstName }} {{ p.lastName }}</span>
                          <span class="opt-meta">{{ p.mrn }} · {{ p.email }}</span>
                        </span>
                      </li>
                    }
                  </ul>
                }
              </div>
            }
          </div>
          <div class="field">
            <label for="ref-hospitalId">Hospital</label>
            <select id="ref-hospitalId" [(ngModel)]="form.hospitalId" title="Hospital">
              <option value="">Select hospital</option>
              @for (h of hospitals(); track h.id) {
                <option [value]="h.id">{{ h.name }}</option>
              }
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label for="ref-specialty">Target Specialty</label>
            <input
              id="ref-specialty"
              type="text"
              [(ngModel)]="form.targetSpecialty"
              placeholder="e.g. Cardiology"
            />
          </div>
          <div class="field">
            <label for="ref-urgency">Urgency</label>
            <select id="ref-urgency" [(ngModel)]="form.urgency" title="Urgency">
              @for (u of urgencies; track u) {
                <option [value]="u">{{ u }}</option>
              }
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="field" style="flex: 1">
            <label for="ref-reason">Referral Reason</label>
            <textarea
              id="ref-reason"
              [(ngModel)]="form.referralReason"
              rows="3"
              placeholder="Reason for referral"
            ></textarea>
          </div>
        </div>
        <div class="form-row">
          <div class="field" style="flex: 1">
            <label for="ref-indication">Clinical Indication</label>
            <textarea
              id="ref-indication"
              [(ngModel)]="form.clinicalIndication"
              rows="2"
              placeholder="Optional"
            ></textarea>
          </div>
        </div>
        <div class="form-row">
          <div class="field" style="flex: 1">
            <label for="ref-summary">Clinical Summary</label>
            <textarea
              id="ref-summary"
              [(ngModel)]="form.clinicalSummary"
              rows="2"
              placeholder="Optional"
            ></textarea>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeModal()">Cancel</button>
        <button class="btn-primary" (click)="submitForm()" [disabled]="saving()">
          {{ saving() ? 'Saving...' : 'Create Referral' }}
        </button>
      </div>
    </div>
  }

  <!-- Cancel Referral Confirmation -->
  @if (showDeleteConfirm()) {
    <div
      class="modal-backdrop"
      tabindex="-1"
      (click)="cancelDeleteAction()"
      (keydown.escape)="cancelDeleteAction()"
    ></div>
    <div class="modal">
      <div class="modal-header">
        <h2>Cancel Referral</h2>
        <button class="modal-close" (click)="cancelDeleteAction()" title="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="delete-warning">
          <span class="material-symbols-outlined">warning</span>
          <p>
            Cancel the referral for <strong>{{ deletingRef()?.patientName }}</strong> to
            <strong>{{ deletingRef()?.targetSpecialty }}</strong
            >?
          </p>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" (click)="cancelDeleteAction()">Keep</button>
        <button class="btn-danger" (click)="executeCancel()" [disabled]="deleting()">
          {{ deleting() ? 'Cancelling...' : 'Cancel Referral' }}
        </button>
      </div>
    </div>
  }
</div>
